<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration - GitHub Migration Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><defs><linearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' stop-color='%236B4C9A'/><stop offset='100%25' stop-color='%2300A19B'/></linearGradient></defs><circle cx='8' cy='8' r='7' fill='url(%23g)'/><path fill='%23fff' d='M8 1C4.1 1 1 4.1 1 8c0 3.1 2 5.7 4.8 6.6.4.1.5-.2.5-.4v-1.3c-2 .4-2.4-1-2.4-1-.3-.9-.8-1.1-.8-1.1-.7-.5 0-.5 0-.5.7.1 1.1.7 1.1.7.6 1.1 1.7.8 2.1.6.1-.5.3-.8.5-.9-1.6-.2-3.2-.8-3.2-3.5 0-.8.3-1.4.7-1.9-.1-.2-.3-.9.1-1.9 0 0 .6-.2 1.9.7.6-.2 1.2-.2 1.8-.2s1.2.1 1.8.2c1.3-.9 1.9-.7 1.9-.7.4 1 .2 1.7.1 1.9.5.5.7 1.1.7 1.9 0 2.7-1.6 3.3-3.2 3.5.2.2.5.6.5 1.3v1.9c0 .2.1.5.5.4C13 13.7 15 11.1 15 8c0-3.9-3.1-7-7-7z'/></svg>" type="image/svg+xml">
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="site-branding">
                    <a href="/" class="site-title-link"><h1 class="site-title">GitHub Migration Dashboard</h1></a>
                    <span class="site-subtitle"><a href="https://spirgroup.dev/docs/spir/component/github-migrate" target="_blank">a SpirGroup project</a></span>
                </div>
                <div class="header-right">
                    <button class="hamburger" id="nav-toggle" onclick="toggleNav()">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    <nav class="main-nav" id="main-nav">
                        <a href="/" class="nav-link">Dashboard</a>
                        <a href="/config" class="nav-link active">Config</a>
                        <a href="/settings" class="nav-link">Settings</a>
                        <a href="/logs" class="nav-link">Logs</a>
                    </nav>
                </div>
            </div>
        </header>

        <main>
            <!-- Organization Synchronizations Section -->
            <section class="config-section">
                <div class="section-header">
                    <h2>Organization Synchronizations</h2>
                    <div class="section-actions">
                        <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="show-archived-syncs" onchange="toggleShowArchivedSyncs()">
                            Show archived
                        </label>
                        <button class="btn btn-primary" onclick="openSyncModal()">+ Add Sync</button>
                    </div>
                </div>
                <div id="syncs-list" class="syncs-list">
                    <!-- Syncs will be rendered here -->
                </div>
            </section>

            <!-- Worker Parameters Section -->
            <section class="config-section">
                <div class="section-header">
                    <h2>Worker Configuration</h2>
                    <button class="btn btn-primary" onclick="saveWorkerConfig()">Save Changes</button>
                </div>
                <div id="worker-config-saved" class="save-message" style="display: none;">
                    ✓ Configuration saved
                </div>
                
                <div class="worker-config-grid">
                    <!-- Discovery Worker -->
                    <div class="config-card">
                        <div class="worker-card-header">
                            <h3>Discovery Worker (Discoverer)</h3>
                            <div class="worker-control">
                                <button class="worker-button" id="discovery-worker-toggle" onclick="toggleDiscoveryWorker()" disabled>...</button>
                                <span class="worker-status" id="discovery-worker-status">Loading...</span>
                            </div>
                        </div>
                        <p class="config-description">Discovers new repositories in source organizations.</p>
                        
                        <div class="form-group">
                            <label for="discovery-run-interval">Run Interval (minutes)</label>
                            <input type="number" id="discovery-run-interval" min="1" max="60" placeholder="1">
                            <span class="field-hint">How often to scan for new repositories (1-60 min)</span>
                        </div>
                    </div>
                    
                    <!-- Status Worker -->
                    <div class="config-card">
                        <div class="worker-card-header">
                            <h3>Status Worker (Checker)</h3>
                            <div class="worker-control">
                                <button class="worker-button" id="status-worker-toggle" onclick="toggleStatusWorker()" disabled>...</button>
                                <span class="worker-status" id="status-worker-status">Loading...</span>
                            </div>
                        </div>
                        <p class="config-description">Checks if repositories need syncing by comparing source and target.</p>
                        
                        <div class="form-group">
                            <label for="status-run-interval">Run Interval (minutes)</label>
                            <input type="number" id="status-run-interval" min="1" max="60" placeholder="1">
                            <span class="field-hint">How often to run the worker (1-60 min)</span>
                        </div>
                        
                        <div class="form-group">
                            <label for="status-recheck-age">Recheck Age (minutes)</label>
                            <input type="number" id="status-recheck-age" min="1" max="60" placeholder="5">
                            <span class="field-hint">Minimum time before a repo is eligible for re-checking</span>
                        </div>
                        
                        <div class="form-group">
                            <label for="status-batch-size">Batch Size</label>
                            <input type="number" id="status-batch-size" min="1" max="50" placeholder="1">
                            <span class="field-hint">Number of repos to check per cycle</span>
                        </div>
                    </div>
                    
                    <!-- Migration Worker -->
                    <div class="config-card">
                        <div class="worker-card-header">
                            <h3>Migration Worker (Queuer)</h3>
                            <div class="worker-control">
                                <button class="worker-button" id="migration-worker-toggle" onclick="toggleMigrationWorker()" disabled>...</button>
                                <span class="worker-status" id="migration-worker-status">Loading...</span>
                            </div>
                        </div>
                        <p class="config-description">Queues unsynced repositories for migration via GEI.</p>
                        
                        <div class="form-group">
                            <label for="migration-run-interval">Run Interval (minutes)</label>
                            <input type="number" id="migration-run-interval" min="1" max="60" placeholder="1">
                            <span class="field-hint">How often to look for new work (1-60 min)</span>
                        </div>
                        
                        <div class="form-group">
                            <label for="migration-max-concurrent">Max Concurrent Queued</label>
                            <input type="number" id="migration-max-concurrent" min="1" max="100" placeholder="10">
                            <span class="field-hint">Maximum number of migrations to queue at once</span>
                        </div>
                    </div>
                    
                    <!-- Progress Worker -->
                    <div class="config-card">
                        <div class="worker-card-header">
                            <h3>Progress Worker (Reporter)</h3>
                            <div class="worker-control">
                                <button class="worker-button" id="progress-worker-toggle" onclick="toggleProgressWorker()" disabled>...</button>
                                <span class="worker-status" id="progress-worker-status">Loading...</span>
                            </div>
                        </div>
                        <p class="config-description">Monitors migration progress and updates status.</p>
                        
                        <div class="form-group">
                            <label for="progress-run-interval">Run Interval (minutes)</label>
                            <input type="number" id="progress-run-interval" min="1" max="60" placeholder="1">
                            <span class="field-hint">How often to check migration progress (1-60 min)</span>
                        </div>
                        
                        <div class="form-group">
                            <label for="progress-stale-timeout">Stale Timeout (minutes)</label>
                            <input type="number" id="progress-stale-timeout" min="30" max="1440" placeholder="120">
                            <span class="field-hint">Mark migration as stale after this time without updates</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Administrators Section -->
            <section class="config-section" id="admin-section">
                <div class="section-header">
                    <h2>Administrator Configuration</h2>
                </div>
                
                <div id="admin-content">
                    <div class="config-card">
                        <!-- Header with user info left, controls right -->
                        <div id="admin-card-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                            <div id="current-user-info">
                                <p>Loading...</p>
                            </div>
                            <div id="admin-header-controls"></div>
                        </div>
                        
                        <!-- Admin mode off: help text and enable button -->
                        <div id="admin-mode-disabled" style="display: none;">
                            <div style="padding: 15px; background: var(--bg-tertiary); border-radius: 4px; margin-bottom: 15px;">
                                <p style="margin: 0 0 8px 0; color: var(--text-secondary);">
                                    <strong>Admin mode is disabled.</strong> All users have full access to make changes.
                                </p>
                                <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">
                                    When enabled, only administrators can modify configurations and trigger migrations. Other users will have read-only access.
                                </p>
                            </div>
                            <button class="btn btn-primary" onclick="enableAdminMode()" id="enable-admin-btn">
                                Enable Admin Mode
                            </button>
                            <span class="field-hint" style="margin-left: 10px;">
                                You will become the first administrator.
                            </span>
                        </div>
                        
                        <!-- Admin mode on: admin list -->
                        <div id="admin-mode-enabled" style="display: none;">
                            <div id="admin-list"></div>
                            
                            <div id="add-admin-form" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color);">
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <input type="email" id="new-admin-email" placeholder="Add administrator email..." autocomplete="off" style="flex: 1;">
                                    <button type="button" class="btn btn-primary btn-small" onclick="addNewAdmin()">
                                        Add
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Read-only notice for non-admins -->
                        <div id="read-only-notice" style="display: none; padding: 15px; background: var(--bg-tertiary); border-radius: 4px; border-left: 4px solid #f0ad4e;">
                            <strong>Read-Only Mode</strong>
                            <p style="margin-top: 5px; margin-bottom: 0; color: var(--text-secondary);">
                                Admin mode is enabled. Contact an administrator for write access.
                            </p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Sync Config Modal -->
    <div id="sync-modal" class="modal">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h2 id="sync-modal-title">Add Sync Configuration</h2>
                <button class="close-btn" onclick="closeSyncModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="sync-form" onsubmit="saveSyncConfig(event)" autocomplete="off">
                    <input type="hidden" id="sync-id" value="">
                    
                    <div class="form-group">
                        <label for="sync-name">Name *</label>
                        <input type="text" id="sync-name" required placeholder="e.g., GHES Production → GitHub.com">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-column">
                            <h3>Source</h3>
                            <div class="form-group">
                                <label for="source-enterprise">Enterprise *</label>
                                <input type="text" id="source-enterprise" required placeholder="enterprise-slug">
                            </div>
                            <div class="form-group">
                                <label for="source-org">Organization *</label>
                                <input type="text" id="source-org" required placeholder="org-name">
                            </div>
                            <div class="form-group">
                                <label for="source-url">API URL (leave empty for github.com)</label>
                                <input type="text" id="source-url" placeholder="https://ghes.example.com/api/v3">
                            </div>
                            <div class="form-group">
                                <label for="source-token">Personal Access Token *</label>
                                <input type="password" id="source-token" required placeholder="ghp_..." autocomplete="off" data-1p-ignore>
                                <p class="field-hint">Classic PAT required with scopes: <code>repo</code>, <code>admin:org</code>, <code>workflow</code>, <code>admin:repo_hook</code>. Must be SSO-authorized for the organization.</p>
                                <p class="field-hint" style="margin-top: 5px;">For Settings Sync, also add: <code>read:enterprise</code>, <code>manage_billing:copilot</code></p>
                            </div>
                            <div id="source-validation-result" class="column-validation-result"></div>
                        </div>
                        <div class="form-column">
                            <h3>Target</h3>
                            <div class="form-group">
                                <label for="target-enterprise">Enterprise *</label>
                                <input type="text" id="target-enterprise" required placeholder="enterprise-slug">
                            </div>
                            <div class="form-group">
                                <label for="target-org">Organization *</label>
                                <input type="text" id="target-org" required placeholder="org-name">
                            </div>
                            <div class="form-group">
                                <label for="target-url">API URL (leave empty for github.com)</label>
                                <input type="text" id="target-url" placeholder="https://ghes.example.com/api/v3">
                            </div>
                            <div class="form-group">
                                <label for="target-token">Personal Access Token *</label>
                                <input type="password" id="target-token" required placeholder="ghp_..." autocomplete="off" data-1p-ignore>
                                <p class="field-hint">Classic PAT required with scopes: <code>repo</code>, <code>admin:org</code>, <code>workflow</code>, <code>admin:repo_hook</code>, <code>delete_repo</code>. Must be SSO-authorized for the organization.</p>
                                <p class="field-hint" style="margin-top: 5px;">For Settings Sync, also add: <code>read:enterprise</code>, <code>manage_billing:copilot</code></p>
                            </div>
                            <div id="target-validation-result" class="column-validation-result"></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="sync-enabled" checked>
                            Enabled
                        </label>
                    </div>
                    
                    <div id="sync-dates" style="display: none; margin-top: 15px; padding: 15px; background: var(--bg-secondary); border-radius: 4px;">
                        <div style="display: flex; gap: 30px;">
                            <div><strong>Created:</strong> <span id="sync-created-at">-</span></div>
                            <div><strong>Last Synced:</strong> <span id="sync-last-synced">-</span></div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn" onclick="validateSyncConfig()">Test Connection</button>
                        <button type="button" class="btn" onclick="closeSyncModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                    
                    <div id="sync-validation-error" class="validation-error" style="margin-top: 15px; display: none;"></div>
                </form>
            </div>
        </div>
    </div>

    <script src="/config.js"></script>
</body>
</html>
